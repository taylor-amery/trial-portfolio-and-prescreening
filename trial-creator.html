<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trial Creator</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: auto; }
        .card { border: 1px solid #ccc; padding: 20px; border-radius: 10px; box-shadow: 2px 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .button { background-color: #007bff; color: white; padding: 10px; border: none; cursor: pointer; margin-top: 10px; }
        .button:disabled { background-color: #ccc; cursor: not-allowed; }
        .treatment, .rule { display: inline-block; padding: 8px; border: 1px solid #ccc; margin: 5px; cursor: pointer; border-radius: 5px; }
        .selected { background-color: #007bff; color: white; }
        ul { padding: 0; list-style: none; }
        li { padding: 8px; border: 1px solid #ddd; margin-top: 5px; border-radius: 5px; background: #f8f8f8; }
        .input-group { margin-bottom: 10px; }
        label { font-weight: bold; }
    </style>
</head>
<body>
    <div class="card">
      <a href="index.html" class="button">Return to Main Page</a>
        <h2 align="center">Trial Creator</h2>
        <div class="input-group">
            <label for="trialName">Trial Name:</label>
            <input type="text" id="trialName">
        </div>
        <div class="input-group">
            <label for="trialDescription">Description:</label>
            <textarea id="trialDescription" rows="3"></textarea>
        </div>
        
        <h3>Select Treatments</h3>
        <div id="treatmentList"></div>
        <input type="text" id="newTreatment" placeholder="Add new treatment">
        <button class="button" onclick="addTreatment()">Add Treatment</button>
        
        <h3>Define Filter Rules</h3>
        <div id="ruleList"></div>
        <button class="button" onclick="addRule()">Add Rule</button>
        
        <button id="saveTrialButton" class="button" onclick="saveTrial()">Save Trial</button>
    </div>
    
    <div class="card">
        <h3>Saved Trials</h3>
        <ul id="savedTrials"></ul>
    </div>
    
    <script>
        let treatments = [];

        function addTreatment() {
            const treatmentInput = document.getElementById("newTreatment").value.trim();
            if (treatmentInput && !treatments.includes(treatmentInput)) {
                treatments.push(treatmentInput);
                updateTreatmentList();
                document.getElementById("newTreatment").value = "";
            }
        }

        function updateTreatmentList() {
            const treatmentList = document.getElementById("treatmentList");
            treatmentList.innerHTML = treatments.map(t => `<span class="treatment">${t}</span>`).join(" ");
        }
        
        function addRule(type = "must", selectedTreatments = []) {
            const ruleDiv = document.createElement("div");
            ruleDiv.className = "rule";
        
            const ruleSelect = document.createElement("select");
            ruleSelect.innerHTML = `
                <option value="must">MUST include</option>
                <option value="must-not">MUST NOT include</option>
                <option value="at-least-one">AT LEAST ONE OF</option>
                <option value="at-most-one">AT MOST ONE OF</option>
            `;
            ruleSelect.value = type;
        
            const treatmentSelect = document.createElement("select");
            treatmentSelect.multiple = true;
            treatmentSelect.innerHTML = treatments.map(t => 
                `<option value="${t}" ${selectedTreatments.includes(t) ? "selected" : ""}>${t}</option>`
            ).join(" ");
        
            ruleDiv.appendChild(ruleSelect);
            ruleDiv.appendChild(treatmentSelect);
            document.getElementById("ruleList").appendChild(ruleDiv);
        }
             
        function saveTrial() {
          const name = document.getElementById("trialName").value.trim();
          const description = document.getElementById("trialDescription").value.trim();
        
          if (!name) {
            alert("Trial must have a name.");
            return;
          }
        
          let trials = JSON.parse(localStorage.getItem("trials")) || [];
        
          // Check if editing
          const saveButton = document.getElementById("saveTrialButton");
          const editingIndex = saveButton.getAttribute("data-index");
        
          const newTrial = {
            name,
            description
          };
        
          if (editingIndex !== null) {
            // Overwrite existing trial
            trials[editingIndex] = newTrial;
            saveButton.removeAttribute("data-index"); // Clear editing state
          } else {
            // Check for duplicate by name
            const duplicate = trials.find(trial => trial.name === name);
            if (duplicate) {
              alert("A trial with this name already exists.");
              return;
            }
            trials.push(newTrial);
          }
        
          localStorage.setItem("trials", JSON.stringify(trials));
          renderTrials();
          document.getElementById("trialForm").reset();
        }
        
        
        function editTrial(index) {
          const trials = JSON.parse(localStorage.getItem("trials")) || [];
          const trial = trials[index];
        
          document.getElementById("trialName").value = trial.name;
          document.getElementById("trialDescription").value = trial.description;
        
          const saveButton = document.getElementById("saveTrialButton");
          saveButton.setAttribute("data-index", index); // Mark for overwrite on save
        }
        
        
        function renderTrials() {
          const trials = JSON.parse(localStorage.getItem("trials")) || [];
          const trialList = document.getElementById("trialList");
          trialList.innerHTML = "";
        
          trials.forEach((trial, index) => {
            const li = document.createElement("li");
            li.textContent = `${trial.name} - ${trial.condition}`;
        
            const editButton = document.createElement("button");
            editButton.textContent = "Edit";
            editButton.onclick = () => editTrial(index);
        
            li.appendChild(editButton);
            trialList.appendChild(li);
          });
        }

    </script>
</body>
</html>
